<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Test Consentement + D√©tection</title>
  <style>
    body { margin:0; background:#111; color:#eee; font-family:sans-serif; text-align:center; }
    #topBar { background:#222; color:#fff; padding:8px; font-weight:bold; }
    #localVideo { display:block; margin:20px auto; width:640px; height:480px; border:4px solid #e74c3c; border-radius:8px; }
    button { margin:10px; padding:10px 20px; font-size:16px; }
    .statusBox { margin:10px auto; width:320px; background:#222; padding:10px; border-radius:8px; }
    #eventLog { max-height:200px; overflow-y:auto; background:#000; padding:10px; margin:10px auto; width:640px; text-align:left; font-size:14px; border-radius:8px; }
  </style>
</head>
<body>
  <div id="topBar">Initialisation...</div>
  <h1>D√©tection de visage avec consentement</h1>

  <video id="localVideo" autoplay muted playsinline></video>

  <div>
    <button id="btnConsentTrue">Activer consentement mutuel</button>
    <button id="btnConsentFalse">D√©sactiver consentement mutuel</button>
  </div>

  <div class="statusBox">
    mutualConsentGiven: <span id="consentValue">false</span><br>
    faceVisible: <span id="faceValue">false</span><br>
    faceRatio: <span id="ratioValue">‚Äì</span><br>
    facesDetected: <span id="facesCount">0</span>
  </div>

  <div id="eventLog"><strong>Logs des √©v√©nements :</strong></div>

  <script src="/js/tracking-min.js"></script>
  <script src="/js/face-min.js"></script>

  <script>
    const video = document.getElementById('localVideo');
    const topBar = document.getElementById('topBar');
    const consentValue = document.getElementById('consentValue');
    const faceValue = document.getElementById('faceValue');
    const ratioValue = document.getElementById('ratioValue');
    const facesCount = document.getElementById('facesCount');
    const eventLog = document.getElementById('eventLog');

    let mutualConsentGiven = false;
    let faceVisible = false;
    let lastAcceptedTime = 0;
    const MIN_FACE_RATIO = 0.01;
    const MAX_VALID_AGE = 2000;

    function logEvent(msg){
      const div = document.createElement('div');
      div.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
      eventLog.appendChild(div);
      eventLog.scrollTop = eventLog.scrollHeight;
    }

    function updateStatusBar(msg,color){
      topBar.textContent = msg;
      topBar.style.color = color;
    }

    function updateBorder(color){
      video.style.border = `4px solid ${color}`;
      video.style.boxShadow = `0 0 10px ${color}`;
    }

    navigator.mediaDevices.getUserMedia({
      video: { width:{ideal:640}, height:{ideal:480} }
    })
    .then(stream => {
      video.srcObject = stream;
      video.onloadedmetadata = () => {
        updateStatusBar(`üé• Webcam initialis√©e ‚úÖ (${video.videoWidth}√ó${video.videoHeight})`,"#0a0");
        logEvent(`Webcam initialis√©e avec r√©solution ${video.videoWidth}√ó${video.videoHeight}`);
      };
    })
    .catch(err => {
      updateStatusBar("‚ùå Erreur webcam: "+err.message,"#a00");
      logEvent("Erreur webcam: "+err.message);
    });

    const tracker = new tracking.ObjectTracker('face');
    tracker.setInitialScale(4);
    tracker.setStepSize(2);
    tracker.setEdgesDensity(0.1);

    tracking.track('#localVideo', tracker);

    tracker.on('track', event => {
      const now = Date.now();
      const videoArea = video.videoWidth * video.videoHeight;
      let acceptedThisFrame = false;

      facesCount.textContent = event.data.length;

      if(event.data.length > 0){
        event.data.forEach(rect => {
          const faceArea = rect.width * rect.height;
          const ratio = faceArea / videoArea;
          ratioValue.textContent = (ratio*100).toFixed(1)+"%";
          if(ratio >= MIN_FACE_RATIO){
            lastAcceptedTime = now;
            acceptedThisFrame = true;
          }
        });
      }

      const age = now - lastAcceptedTime;

      if(acceptedThisFrame || age < MAX_VALID_AGE){
        faceVisible = true;
        faceValue.textContent = "true";
        updateBorder(mutualConsentGiven ? "#3498db" : "#2ecc71");
        updateStatusBar(mutualConsentGiven ? "Consentement mutuel donn√© ‚úÖ" : "Visage d√©tect√© ‚úÖ","#0a0");
      } else {
        faceVisible = false;
        faceValue.textContent = "false";
        updateBorder("#e74c3c");
        updateStatusBar("Aucun visage d√©tect√© ‚ùå","#a00");
      }
    });

    document.getElementById('btnConsentTrue').addEventListener('click',()=>{
      mutualConsentGiven = true;
      consentValue.textContent = "true";
      logEvent("Consentement mutuel activ√©");
    });
    document.getElementById('btnConsentFalse').addEventListener('click',()=>{
      mutualConsentGiven = false;
      consentValue.textContent = "false";
      logEvent("Consentement mutuel d√©sactiv√©");
    });
  </script>
</body>
</html>
