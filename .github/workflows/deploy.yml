name: Deploy to VPS

on:
  push:
      branches: [main]

      jobs:
        deploy:
            runs-on: ubuntu-latest

                steps:
                      - name: Checkout repo
                              uses: actions/checkout@v4

                                    - name: Deploy over SSH
                                            uses: appleboy/ssh-action@v1.0.3
                                                    with:
                                                              host: ${{ secrets.VPS_HOST }}
                                                                        username: ${{ secrets.VPS_USER }}
                                                                                  key: ${{ secrets.VPS_SSH_KEY }}
                                                                                            script_stop: true
                                                                                                      command_timeout: 30m
                                                                                                                script: |
                                                                                                                            set -e

                                                                                                                                        # 1) Récupérer le code
                                                                                                                                                    if [ -d ~/LegalShuffleCam ]; then
                                                                                                                                                                  cd ~/LegalShuffleCam
                                                                                                                                                                                git fetch origin main
                                                                                                                                                                                              git checkout -B main origin/main
                                                                                                                                                                                                          else
                                                                                                                                                                                                                        git clone git@github.com:marienjoanny/LegalShuffleCam.git ~/LegalShuffleCam
                                                                                                                                                                                                                                      cd ~/LegalShuffleCam
                                                                                                                                                                                                                                                    git checkout main || true
                                                                                                                                                                                                                                                                fi

                                                                                                                                                                                                                                                                            # 2) Dépendances (utilise package-lock si présent)
                                                                                                                                                                                                                                                                                        if command -v npm >/dev/null 2>&1; then
                                                                                                                                                                                                                                                                                                      npm ci || npm install
                                                                                                                                                                                                                                                                                                                  fi

                                                                                                                                                                                                                                                                                                                              # 3) (Re)démarrage via PM2
                                                                                                                                                                                                                                                                                                                                          if pm2 describe legalshufflecam >/dev/null 2>&1; then
                                                                                                                                                                                                                                                                                                                                                        pm2 restart legalshufflecam
                                                                                                                                                                                                                                                                                                                                                                    else
                                                                                                                                                                                                                                                                                                                                                                                  PORT=3000 pm2 start server.js --name legalshufflecam
                                                                                                                                                                                                                                                                                                                                                                                              fi

                                                                                                                                                                                                                                                                                                                                                                                                          # 4) Persister le process pour reboot
                                                                                                                                                                                                                                                                                                                                                                                                                      pm2 save
